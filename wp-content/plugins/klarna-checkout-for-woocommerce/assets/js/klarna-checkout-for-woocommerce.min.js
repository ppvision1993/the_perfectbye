jQuery(function(l){if("undefined"==typeof kco_params)return!1;var u={bodyEl:l("body"),checkoutFormSelector:"form.checkout",orderNotesValue:"",orderNotesSelector:"textarea#order_comments",orderNotesEl:l("textarea#order_comments"),extraFieldsValues:{},extraFieldsSelectorText:'div#kco-extra-fields input[type="text"], div#kco-extra-fields input[type="password"], div#kco-extra-fields textarea, div#kco-extra-fields input[type="email"], div#kco-extra-fields input[type="tel"]',extraFieldsSelectorNonText:'div#kco-extra-fields select, div#kco-extra-fields input[type="radio"], div#kco-extra-fields input[type="checkbox"], div#kco-extra-fields input.checkout-date-picker, input#terms input[type="checkbox"]',paymentMethodEl:l('input[name="payment_method"]'),paymentMethod:"",selectAnotherSelector:"#klarna-checkout-select-other",shippingUpdated:!1,blocked:!1,documentReady:function(){u.setFormFieldValues(),u.log(kco_params),u.checkFormData(),0<u.paymentMethodEl.length?u.paymentMethod=u.paymentMethodEl.filter(":checked").val():u.paymentMethod="kco",u.confirmLoading()},kcoSuspend:function(o){window._klarnaCheckout&&window._klarnaCheckout(function(e){e.suspend({autoResume:{enabled:o}})})},kcoResume:function(){window._klarnaCheckout&&window._klarnaCheckout(function(e){!1===u.blocked&&e.resume()})},confirmLoading:function(){l("#kco-confirm-loading").css("minHeight","300px").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateCart:function(){u.kcoSuspend(!0),l.ajax({type:"POST",url:kco_params.update_cart_url,data:{checkout:l("form.checkout").serialize(),nonce:kco_params.update_cart_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){l("body").trigger("update_checkout"),u.kcoResume()}})},updateExtraFields:function(){var t=l(this),a=u.formFields,c=t.attr("name"),n=t.val();l.each(a,function(e,o){o.name===c&&(t.is(":checkbox")&&(t.is(":checked")||(n="")),t.is(":radio ")&&(t.is(":checked")||(n="")),"select-one"===t.prop("type")&&(n=t.find(":selected").val()),a[e].value=n)}),u.formFields=a},updateOrderNotes:function(){u.orderNotesEl.val()!==u.orderNotesValue&&(u.orderNotesValue=u.orderNotesEl.val(),l.ajax({type:"POST",url:kco_params.update_order_notes_url,data:{order_notes:u.orderNotesValue,nonce:kco_params.update_order_notes_nonce},success:function(e){},error:function(e){},complete:function(e){u.log("complete",e)}}))},updateKlarnaOrder:function(){"kco"===u.paymentMethod&&"no"===kco_params.is_confirmation_page&&(u.kcoSuspend(),l(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l.ajax({type:"POST",url:kco_params.update_klarna_order_url,data:{nonce:kco_params.update_klarna_order_nonce},dataType:"json",success:function(e){},error:function(e){},complete:function(e){!0===e.responseJSON.success?(u.kcoResume(),l(".woocommerce-checkout-review-order-table").unblock()):""!==e.responseJSON.data.redirect_url&&(console.log("Cart do not need payment. Reloading checkout."),window.location.href=e.responseJSON.data.redirect_url)}}))},maybeDisplayShippingPrice:function(){if("kco"===u.paymentMethod&&"yes"===kco_params.shipping_methods_in_iframe&&"no"===kco_params.is_confirmation_page)if(jQuery("#shipping_method input[type='radio']").length)l("#shipping_method input[type='radio']:checked").each(function(){var e=l(this).attr("id"),o=l("label[for='"+e+"']").text();l(".woocommerce-shipping-totals td").html(o)});else{var e=l("#shipping_method input[name='shipping_method[0]']").attr("id"),o=l("label[for='"+e+"']").text();l(".woocommerce-shipping-totals td").html(o)}},changeFromKco:function(e){e.preventDefault(),l(u.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l.ajax({type:"POST",dataType:"json",data:{kco:!1,nonce:kco_params.change_payment_method_nonce},url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){u.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})},maybeChangeToKco:function(){u.log(l(this).val()),"kco"===l(this).val()&&(l(".woocommerce-info").remove(),l(u.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l.ajax({type:"POST",data:{kco:!0,nonce:kco_params.change_payment_method_nonce},dataType:"json",url:kco_params.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){u.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}}))},checkoutError:function(){if("kco"===u.paymentMethod&&"yes"===kco_params.is_confirmation_page){var e=l(".woocommerce-NoticeGroup-checkout").text();l.ajax({type:"POST",dataType:"json",data:{kco:!1,error_message:e,nonce:kco_params.checkout_error_nonce},url:kco_params.checkout_error_url,success:function(e){},error:function(e){},complete:function(e){u.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})}},log:function(e){kco_params.logging&&console.log(e)},checkFormData:function(){var e=l('form[name="checkout"] input, form[name="checkout"] select, textarea'),o=[],t={},a=l('form[name="checkout"]').find(".validate-required:visible");for(i=0;i<e.length;i++)if(""!==e[i].name){var c=e[i].name,n=l('*[name="'+c+'"]');if("-1"==l.inArray(c,kco_params.standard_woo_checkout_fields)&&c.indexOf("[qty]")<0&&c.indexOf("shipping_method")<0&&c.indexOf("payment_method")<0){var r="";n.is(":checkbox")?n.is(":checked")&&(r=e[i].value):n.is(":radio")?n.is(":checked")&&(r=l('input[name="'+c+'"]:checked').val()):r=e[i].value,t[c]=r}}for(i=0;i<a.length;i++){var d=a[i],s=l(d).find(":input");if(0<s.length){c=s.attr("name");"-1"==l.inArray(c,kco_params.standard_woo_checkout_fields)&&c.indexOf("[qty]")<0&&c.indexOf("shipping_method")<0&&c.indexOf("payment_method")<0&&o.push(c)}}sessionStorage.setItem("KCORequiredFields",JSON.stringify(o)),sessionStorage.setItem("KCOFieldData",JSON.stringify(t)),!0===u.shippingUpdated&&u.validateRequiredFields()},validateRequiredFields:function(){var e=JSON.parse(sessionStorage.getItem("KCORequiredFields")),o=JSON.parse(sessionStorage.getItem("KCOFieldData")),t=!0;if(null!==e)for(i=0;i<e.length;i++)fieldName=e[i],""===o[fieldName]&&(t=!1);u.maybeSuspendIframe(t)},maybeSuspendIframe:function(e){if(!0===e)u.blocked=!1,l("#kco-required-fields-notice").remove(),u.kcoResume();else if(!l("#kco-required-fields-notice").length){u.blocked=!0,l("form.checkout").prepend('<div id="kco-required-fields-notice" class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+kco_params.required_fields_text+"</li></ul></div>");var o=l("form.checkout").offset().top;l("html, body").animate({scrollTop:o},1e3),u.kcoSuspend(!1)}},maybePrintValidationMessage:function(){if(!0===u.blocked&&!l("#kco-required-fields-notice").length){l("form.checkout").prepend('<div id="kco-required-fields-notice" class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+kco_params.required_fields_text+"</li></ul></div>");var e=l("form.checkout").offset().top;l("html, body").animate({scrollTop:e},1e3)}},setFormFieldValues:function(){var e=JSON.parse(sessionStorage.getItem("KCOFieldData"));null!==e&&l.each(e,function(e,o){var t=l('*[name="'+e+'"]'),a=o;if(t.is(":checkbox"))""!==a&&t.prop("checked",!0);else if(t.is(":radio"))for(x=0;x<t.length;x++)t[x].value===o&&l(t[x]).prop("checked",!0);else t.val(a)})},setFieldValues:function(e){l("#billing_email").val(e.customer_data.billing_email),l("#billing_postcode").val(e.customer_data.billing_postcode),l("#billing_state").val(e.customer_data.billing_state),l("#billing_country").val(e.customer_data.billing_country),l("#shipping_postcode").val(e.customer_data.shipping_postcode),l("#shipping_state").val(e.customer_data.shipping_state),l("#shipping_country").val(e.customer_data.billing_country),l("#billing_email").change(),l("#billing_email").blur()},init:function(){l(document).ready(u.documentReady),u.bodyEl.on("update_checkout",u.kcoSuspend(!0)),u.bodyEl.on("updated_checkout",u.updateKlarnaOrder),u.bodyEl.on("updated_checkout",u.maybeDisplayShippingPrice),u.bodyEl.on("updated_checkout",u.maybePrintValidationMessage),u.bodyEl.on("checkout_error",u.checkoutError),u.bodyEl.on("change","input.qty",u.updateCart),u.bodyEl.on("change",'input[name="payment_method"]',u.maybeChangeToKco),u.bodyEl.on("click",u.selectAnotherSelector,u.changeFromKco),u.bodyEl.on("blur",u.extraFieldsSelectorText,u.checkFormData),u.bodyEl.on("change",u.extraFieldsSelectorNonText,u.checkFormData),u.bodyEl.on("click","input#terms",u.checkFormData),"function"==typeof window._klarnaCheckout&&window._klarnaCheckout(function(e){e.on({shipping_address_change:function(e){u.log("shipping_address_change"),u.log(e),l(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),u.kcoSuspend(!0),l.ajax({url:kco_params.iframe_shipping_address_change_url,type:"POST",dataType:"json",data:{data:e,nonce:kco_params.iframe_shipping_address_change_nonce},success:function(e){if(u.log(e),"yes"==e.data.must_login){u.kcoSuspend(!1),l("form.checkout").prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+e.data.must_login_message+"</li></ul></div>");var o=l("form.checkout").offset().top;l("html, body").animate({scrollTop:o},1e3)}else u.kcoResume(),u.validateRequiredFields(),u.setFieldValues(e.data),l("body").trigger("update_checkout")},error:function(e){u.log(e)},complete:function(e){l(".woocommerce-checkout-review-order-table").unblock(),u.shippingUpdated=!0,u.bodyEl.trigger("kco_shipping_address_changed",e)}})},change:function(e){u.log("change",e)},order_total_change:function(e){u.log("order_total_change",e)},shipping_option_change:function(o){u.log("shipping_option_change",o),u.log(o),l(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),u.kcoSuspend(!0),l.ajax({url:kco_params.update_shipping_url,type:"POST",dataType:"json",data:{data:o,nonce:kco_params.update_shipping_nonce},success:function(e){u.log(e),l("body").trigger("update_checkout")},error:function(e){u.log(e)},complete:function(e){l("#shipping_method #"+e.responseJSON.data.shipping_option_name).prop("checked",!0),console.log("triggering TMS stuff."),l("body").trigger("kco_shipping_option_changed",[o]),l(".woocommerce-checkout-review-order-table").unblock(),u.kcoResume()}})},can_not_complete_order:function(e){u.log("can_not_complete_order",e)}})})}};u.init(),l("body").on("blur",u.checkFormData),l(document).on("keypress","#kco-order-review .qty",function(e){13==e.keyCode&&e.preventDefault()})});